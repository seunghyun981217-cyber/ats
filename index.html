<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ATS MAP</title>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    header {
        padding: 10px 15px;
        font-size: 20px;
        font-weight: bold;
        background: #1E88E5;
        color: white;
    }
    #controls {
        display: flex;
        gap: 10px;
        padding: 10px;
        background: #f3f3f3;
        align-items: center;
    }
    #map {
        flex: 1;
    }
</style>
</head>

<body>

<header>ATS 지도 (구별 색상 동그란 점 마커)</header>

<div id="controls">
    <select id="districtSelect">
        <option value="ALL">전체 구</option>
        <option value="광진구">광진구</option>
        <option value="성동구">성동구</option>
        <option value="강남구">강남구</option>
        <option value="서초구">서초구</option>
        <option value="송파구">송파구</option>
        <option value="강동구">강동구</option>
    </select>

    <select id="typeSelect">
        <option value="ALL">모든 유형</option>
        <option value="수리">수리</option>
        <option value="충전">충전</option>
        <option value="공기주입">공기주입</option>
        <option value="대여">대여</option>
    </select>
</div>

<div id="map"></div>

<script>
// ⭐ 색상 (구별 점 색상)
const DISTRICT_COLORS = {
    "광진구": "#F44336",
    "성동구": "#9C27B0",
    "강남구": "#2196F3",
    "서초구": "#4CAF50",
    "송파구": "#FFC107",
    "강동구": "#FF5722",
};

// ⭐ 구별 KML URL
const KML_FILES = {
    "광진구": "https://seunghyun981217-cyber.github.io/ats/kml/GwangsungATSMAPS.kml",
    "성동구": "https://seunghyun981217-cyber.github.io/ats/kml/GwangsungATSMAPS.kml",
    "강남구": "https://seunghyun981217-cyber.github.io/ats/kml/KangnamseochoATSMAPS.kml",
    "서초구": "https://seunghyun981217-cyber.github.io/ats/kml/KangnamseochoATSMAPS.kml",
    "송파구": "https://seunghyun981217-cyber.github.io/ats/kml/GangdongsongpaATSMAPS.kml",
    "강동구": "https://seunghyun981217-cyber.github.io/ats/kml/GangdongsongpaATSMAPS.kml"
};

// ⭐ 저장용
let map;
let markers = [];

// ⭐ 동그란 점 아이콘 (A 버전)
function getDotIcon(colorHex) {
    const hex = colorHex.replace("#", "");
    return {
        url: `https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|${hex}`,
        scaledSize: new google.maps.Size(40, 40)
    };
}

// ⭐ 지도 초기화
function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 37.540, lng: 127.070 },
        zoom: 12,
        mapTypeControl: false,
    });

    loadDistrict("ALL");

    document.getElementById("districtSelect").addEventListener("change", filter);
    document.getElementById("typeSelect").addEventListener("change", filter);
}

// ⭐ 구 선택하면 해당 KML 읽어 markers 생성
async function loadDistrict(district) {
    clearMarkers();

    if (district === "ALL") {
        for (const d in KML_FILES) {
            await loadKML(DISTRICT_COLORS[d], KML_FILES[d]);
        }
    } else {
        await loadKML(DISTRICT_COLORS[district], KML_FILES[district]);
    }
}

// ⭐ KML → 파싱 → 점 찍기
async function loadKML(color, url) {
    const res = await fetch(url);
    const text = await res.text();

    const parser = new DOMParser();
    const xml = parser.parseFromString(text, "text/xml");

    const placemarks = xml.getElementsByTagName("Placemark");

    for (let p of placemarks) {
        const name = p.getElementsByTagName("name")[0]?.textContent || "";
        const desc = p.getElementsByTagName("description")[0]?.textContent || "";
        const coordStr = p.getElementsByTagName("coordinates")[0]?.textContent.trim();

        if (!coordStr) continue;

        const [lng, lat] = coordStr.split(",");

        const marker = new google.maps.Marker({
            position: { lat: Number(lat), lng: Number(lng) },
            map,
            icon: getDotIcon(color)
        });

        markers.push({ marker, name, desc });
    }
}

// ⭐ 필터
function filter() {
    const d = document.getElementById("districtSelect").value;
    const t = document.getElementById("typeSelect").value;

    clearMarkers();
    loadDistrict(d);
}

// ⭐ 기존 마커 지우기
function clearMarkers() {
    markers.forEach(obj => obj.marker.setMap(null));
    markers = [];
}
</script>

<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRFrDGLMi8UZgAoDITyJu694vKXdTglbU&callback=initMap"
    async defer></script>

</body>
</html>
