<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ATS ìŠ¤ë§ˆíŠ¸ë§µ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Noto Sans KR", sans-serif;
      display: flex;
      height: 100vh;
    }
    .panel {
      width: 340px;
      padding: 14px;
      border-right: 1px solid #e5e7eb;
      background: #ffffff;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .panel h3 {
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 800;
    }
    .label {
      font-size: 13px;
      margin: 10px 0 4px;
      font-weight: 600;
    }
    select, input {
      width: 100%;
      padding: 6px 8px;
      margin-bottom: 6px;
      box-sizing: border-box;
      font-size: 13px;
    }
    #resultList {
      margin-top: 8px;
      border-top: 1px solid #eee;
      padding-top: 6px;
      font-size: 12px;
      max-height: 260px;
      overflow-y: auto;
    }
    .result-item {
      padding: 6px 4px;
      border-bottom: 1px dashed #e5e7eb;
      cursor: pointer;
    }
    .result-item:hover {
      background: #f3f4f6;
    }
    #map {
      flex: 1;
    }
  </style>
</head>

<body>
  <div class="panel">
    <h3>ATS ìŠ¤ë§ˆíŠ¸ë§µ</h3>

    <div class="label">êµ¬ ì„ íƒ</div>
    <select id="districtSelect">
      <option value="ALL">ì „ì²´ êµ¬</option>
    </select>

    <div class="label">ìœ í˜• ì„ íƒ</div>
    <select id="typeSelect">
      <option value="ALL">ì „ì²´ ìœ í˜•</option>
    </select>

    <div class="label">ê²€ìƒ‰ (ì´ë¦„/ì„¤ëª…)</div>
    <input id="searchInput" type="text" placeholder="ì˜ˆ: ì†¡íŒŒ, ëŒ€ì—¬, ì¶©ì „ì†Œâ€¦" />

    <div class="label">ê²°ê³¼ ëª©ë¡</div>
    <div id="resultList">ì¡°ê±´ì„ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•´ ì£¼ì„¸ìš”.</div>
  </div>

  <div id="map"></div>

  <script>
    // âœ… ì—¬ê¸°ì— ë„¤ê°€ ì‚¬ìš© ì¤‘ì¸ KML íŒŒì¼ë“¤ì„ ë‚˜ì—´í•´ì¤˜
    //   /ats/kml/ í´ë” ê¸°ì¤€ ê²½ë¡œ
    const KML_URLS = [
      "kml/GwangsungATSMAPS.kml",
      "kml/KangnamseochoATSMAPS.kml",
      "kml/GangdongsongpaATSMAPS.kml",
      // í•„ìš”í•˜ë©´ ì—¬ê¸° ì•„ë˜ì— ì¶”ê°€:
      // "kml/JungguWheelchairCharge.kml",
      // "kml/GwanakWheelchairCharge.kml"
    ];

    let map, infoWindow;
    let PLACES = [];   // { name, lat, lng, type, district, description, marker }
    let markers = [];
    let selectedDistrict = "ALL";
    let selectedType = "ALL";

    // âœ… KML íŒŒì‹±ìš© í•¨ìˆ˜
    function parseKmlText(text) {
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "text/xml");
      const placemarks = xml.getElementsByTagName("Placemark");
      const places = [];

      for (let i = 0; i < placemarks.length; i++) {
        const pm = placemarks[i];
        const name = pm.getElementsByTagName("name")[0]?.textContent.trim() || "";
        const descNode = pm.getElementsByTagName("description")[0];
        const description = descNode ? descNode.textContent.trim() : "";

        const coordNode = pm.getElementsByTagName("coordinates")[0];
        if (!coordNode) continue;
        const coordText = coordNode.textContent.trim();
        const parts = coordText.split(",");
        if (parts.length < 2) continue;
        const lng = parseFloat(parts[0]);
        const lat = parseFloat(parts[1]);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;

        let district = "";
        let type = "";

        const datas = pm.getElementsByTagName("Data");
        for (let j = 0; j < datas.length; j++) {
          const d = datas[j];
          const key = d.getAttribute("name");
          const valNode = d.getElementsByTagName("value")[0];
          const val = valNode ? valNode.textContent.trim() : "";
          if (key === "district" || key === "êµ¬") district = val;
          if (key === "type" || key === "ìœ í˜•") type = val;
        }

        places.push({ name, lat, lng, type, district, description });
      }
      return places;
    }

    // âœ… ìë™ ìƒ‰ìƒ ìƒì„± (êµ¬ë³„ ìƒ‰ìƒ)
    function colorFromText(text) {
      if (!text) return "#999999";
      let hash = 0;
      for (let i = 0; i < text.length; i++) {
        hash = text.charCodeAt(i) + ((hash << 5) - hash);
      }
      const hue = Math.abs(hash) % 360;
      return `hsl(${hue}, 65%, 50%)`;
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 37.52, lng: 127.08 },
        zoom: 12,
        mapTypeControl: false,
        streetViewControl: false,
      });
      infoWindow = new google.maps.InfoWindow();

      // ëª¨ë“  KML ë¡œë“œ
      Promise.all(
        KML_URLS.map(url =>
          fetch(url + "?v=" + Date.now()).then(res => res.text())
        )
      ).then(texts => {
        texts.forEach(t => {
          const places = parseKmlText(t);
          PLACES = PLACES.concat(places);
        });
        createMarkers();
        initSelectors();
        applyFilters();
      }).catch(err => {
        console.error("KML ë¡œë”© ì˜¤ë¥˜:", err);
        document.getElementById("resultList").textContent =
          "KML ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê²½ë¡œë‚˜ íŒŒì¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
      });

      // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
      document.getElementById("searchInput").addEventListener("input", () => {
        applyFilters();
      });
    }

    function createMarkers() {
      markers.forEach(m => m.setMap(null));
      markers = [];

      PLACES.forEach(p => {
        const marker = new google.maps.Marker({
          position: { lat: p.lat, lng: p.lng },
          map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 6,
            fillColor: colorFromText(p.district),
            fillOpacity: 0.95,
            strokeColor: "#ffffff",
            strokeWeight: 1,
          },
          title: p.name,
        });
        marker.placeData = p;
        p.marker = marker;

        marker.addListener("click", () => {
          openInfo(marker);
        });

        markers.push(marker);
      });
    }

    function openInfo(marker) {
      const p = marker.placeData;
      const html = `
        <div style="font-size:13px; line-height:1.4; max-width:260px;">
          <div style="font-weight:700; margin-bottom:4px;">${p.name}</div>
          <div style="font-size:11px; color:#555; margin-bottom:4px;">
            ${p.district || ""} ${p.type ? " Â· " + p.type : ""}
          </div>
          <div style="font-size:12px; white-space:pre-line;">${p.description || ""}</div>
        </div>
      `;
      infoWindow.setContent(html);
      infoWindow.open(map, marker);
    }

    function initSelectors() {
      const dSel = document.getElementById("districtSelect");
      const tSel = document.getElementById("typeSelect");

      const districtSet = new Set();
      const typeSet = new Set();

      PLACES.forEach(p => {
        if (p.district) districtSet.add(p.district);
        if (p.type) typeSet.add(p.type);
      });

      [...districtSet].sort().forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        dSel.appendChild(opt);
      });

      [...typeSet].sort().forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        tSel.appendChild(opt);
      });

      dSel.addEventListener("change", e => {
        selectedDistrict = e.target.value;
        applyFilters();
      });

      tSel.addEventListener("change", e => {
        selectedType = e.target.value;
        applyFilters();
      });
    }

    function applyFilters() {
      const q = document.getElementById("searchInput").value.trim().toLowerCase();
      const visiblePlaces = [];

      markers.forEach(m => {
        const p = m.placeData;
        const okDistrict =
          selectedDistrict === "ALL" || p.district === selectedDistrict;
        const okType =
          selectedType === "ALL" || p.type === selectedType;
        const okSearch =
          !q ||
          p.name.toLowerCase().includes(q) ||
          (p.description && p.description.toLowerCase().includes(q));

        const visible = okDistrict && okType && okSearch;
        m.setVisible(visible);
        if (visible) visiblePlaces.push(p);
      });

      updateResultList(visiblePlaces);
    }

    function updateResultList(places) {
      const list = document.getElementById("resultList");
      list.innerHTML = "";

      if (!places.length) {
        list.textContent = "í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      places.forEach(p => {
        const div = document.createElement("div");
        div.className = "result-item";
        div.innerHTML = `
          <strong>${p.name}</strong><br/>
          <span style="color:#555;">${p.district || ""} Â· ${p.type || ""}</span>
        `;
        div.onclick = () => {
          map.panTo({ lat: p.lat, lng: p.lng });
          map.setZoom(15);
          if (p.marker) openInfo(p.marker);
        };
        list.appendChild(div);
      });
    }
  </script>

  <!-- ğŸ”‘ ì—¬ê¸° YOUR_GOOGLE_MAPS_API_KEY ë¥¼ ë„¤ í‚¤ë¡œ êµì²´ -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRFrDGLMi8UZgAoDITyJu694vKXdTglbU&callback=initMap&language=ko" async defer></script>
</body>
</html>
