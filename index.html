<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ATS 스마트맵</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif; }
    #app { display:flex; height:100%; }
    #sidebar {
      width:320px; max-width:90vw; background:#fff; border-right:1px solid #eee;
      padding:14px 12px; box-sizing:border-box; overflow:auto;
    }
    #map { flex:1; }
    h1 { font-size:18px; margin:2px 0 10px; }
    .section { margin:12px 0; }
    label { font-size:13px; color:#333; display:block; margin-bottom:6px; }
    select, input {
      width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:10px; font-size:14px;
      outline:none;
    }
    button {
      width:100%; padding:9px 10px; border:0; border-radius:10px; font-size:14px; cursor:pointer;
      background:#111; color:#fff;
    }
    .small { font-size:12px; color:#666; margin-top:6px; line-height:1.4; }
    .chips { display:flex; flex-wrap:wrap; gap:6px; }
    .chip {
      font-size:12px; padding:4px 8px; border-radius:999px; background:#f3f4f6; color:#111;
    }
    .loading { font-size:13px; color:#999; margin-top:8px; }

    /* 모바일 */
    @media (max-width: 680px){
      #sidebar { width: 46vw; }
    }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h1>ATS 스마트맵</h1>
    <div class="small">
      서울 이동보조기기 사용자들을 위한<br/>
      수리·충전·대여 정보를 한눈에.
    </div>

    <div class="section">
      <label>검색</label>
      <input id="searchInput" placeholder="업체명/장소명 검색" />
      <div class="small">검색어가 포함된 마커만 남겨서 보여줘요.</div>
    </div>

    <div class="section">
      <label>구 선택</label>
      <select id="districtSelect">
        <option value="ALL">전체 보기</option>
        <option value="광진구">광진구</option>
        <option value="성동구">성동구</option>
        <option value="강남구">강남구</option>
        <option value="서초구">서초구</option>
        <option value="송파구">송파구</option>
        <option value="강동구">강동구</option>
      </select>
    </div>

    <div class="section">
      <label>유형 선택 (4종 고정)</label>
      <select id="typeSelect">
        <option value="ALL">모든 유형</option>
        <option value="수리 지정업체">수리 지정업체</option>
        <option value="전동휠체어 충전소">전동휠체어 충전소</option>
        <option value="휠체어 대여소">휠체어 대여소</option>
        <option value="휴대용 충전기 대여소">휴대용 충전기 대여소</option>
      </select>
      <div class="chips" style="margin-top:8px;">
        <div class="chip">수리 지정업체</div>
        <div class="chip">전동휠체어 충전소</div>
        <div class="chip">휠체어 대여소</div>
        <div class="chip">휴대용 충전기 대여소</div>
      </div>
    </div>

    <div class="section">
      <button id="resetBtn">필터 초기화</button>
      <div id="loading" class="loading">데이터 불러오는 중…</div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
  // ✅ 너의 GitHub Pages 구조
  const KML_FILES = [
    "kml/GwangsungATSMAPS.kml",
    "kml/KangnamseochoATSMAPS.kml",
    "kml/GangdongsongpaATSMAPS.kml",
  ];

  // ✅ 4개 유형 라벨
  const TYPE_LABELS = {
    REPAIR: "수리 지정업체",
    CHARGE: "전동휠체어 충전소",
    RENT_WHEEL: "휠체어 대여소",
    RENT_BATTERY: "휴대용 충전기 대여소",
    OTHER: "기타"
  };

  // ✅ 타입 정규화(핵심)
  function normalizeType(rawType, name="", desc="") {
    const t = (rawType || "").toLowerCase();
    const n = (name || "").toLowerCase();
    const d = (desc || "").toLowerCase();
    const all = t + " " + n + " " + d;

    // 1) 수리 지정업체
    if (
      all.includes("수리") ||
      all.includes("repair") ||
      all.includes("정비") ||
      all.includes("센터수리") ||
      all.includes("지정업체")
    ) return TYPE_LABELS.REPAIR;

    // 2) 전동휠체어 충전소
    if (
      all.includes("충전") ||
      all.includes("charge") ||
      all.includes("전동휠체어") ||
      all.includes("전동 휠체어")
    ) return TYPE_LABELS.CHARGE;

    // 3) 휠체어 대여소
    if (
      all.includes("대여") && (all.includes("휠체어") || all.includes("wheelchair")) ||
      all.includes("휠체어 대여")
    ) return TYPE_LABELS.RENT_WHEEL;

    // 4) 휴대용 충전기 대여소
    if (
      all.includes("휴대용") ||
      all.includes("보조배터리") ||
      all.includes("충전기 대여") ||
      all.includes("portable")
    ) return TYPE_LABELS.RENT_BATTERY;

    return TYPE_LABELS.OTHER;
  }

  // ✅ 타입별 마커 색상
  function typeColor(typeLabel) {
    switch(typeLabel){
      case TYPE_LABELS.REPAIR: return "#16a34a";      // green
      case TYPE_LABELS.CHARGE: return "#2563eb";      // blue
      case TYPE_LABELS.RENT_WHEEL: return "#f59e0b";  // amber
      case TYPE_LABELS.RENT_BATTERY: return "#a855f7";// purple
      default: return "#6b7280";                      // gray
    }
  }

  let map, infoWindow;
  let allMarkers = [];   // { marker, district, typeLabel, name, desc }

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: {lat: 37.53, lng: 127.05},
      zoom: 11,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: true,
      styles: [
        { featureType: "poi", stylers: [{ visibility: "off" }] },
        { featureType: "transit", stylers: [{ visibility: "off" }] },
      ]
    });

    infoWindow = new google.maps.InfoWindow();

    loadAllKml();
    bindUI();
  }

  function bindUI(){
    const districtSelect = document.getElementById("districtSelect");
    const typeSelect = document.getElementById("typeSelect");
    const searchInput = document.getElementById("searchInput");
    const resetBtn = document.getElementById("resetBtn");

    function apply(){
      const dVal = districtSelect.value;
      const tVal = typeSelect.value;
      const q = searchInput.value.trim().toLowerCase();

      allMarkers.forEach(o=>{
        const passDistrict = (dVal === "ALL") || (o.district === dVal);
        const passType = (tVal === "ALL") || (o.typeLabel === tVal);
        const passQuery = !q || (o.name.toLowerCase().includes(q) || o.desc.toLowerCase().includes(q));
        o.marker.setVisible(passDistrict && passType && passQuery);
      });
    }

    districtSelect.addEventListener("change", apply);
    typeSelect.addEventListener("change", apply);
    searchInput.addEventListener("input", apply);

    resetBtn.addEventListener("click", ()=>{
      districtSelect.value = "ALL";
      typeSelect.value = "ALL";
      searchInput.value = "";
      apply();
    });
  }

  async function loadAllKml(){
    const loadingEl = document.getElementById("loading");
    loadingEl.style.display = "block";

    for (const file of KML_FILES){
      try{
        const text = await fetch(file + "?v=" + Date.now()).then(r=>r.text());
        parseKml(text);
      }catch(e){
        console.error("KML load fail:", file, e);
      }
    }

    loadingEl.style.display = "none";
    fitToMarkers();
  }

  function parseKml(kmlText){
    const parser = new DOMParser();
    const xml = parser.parseFromString(kmlText, "text/xml");
    const placemarks = [...xml.getElementsByTagName("Placemark")];

    placemarks.forEach(pm=>{
      const name = (pm.getElementsByTagName("name")[0]?.textContent || "").trim();
      const descRaw = (pm.getElementsByTagName("description")[0]?.textContent || "").trim();

      // ExtendedData -> Data[name=...]
      let rawType = "";
      let district = "";

      const datas = [...pm.getElementsByTagName("Data")];
      datas.forEach(d=>{
        const key = d.getAttribute("name");
        const val = (d.getElementsByTagName("value")[0]?.textContent || "").trim();
        if (!key) return;
        if (key.toLowerCase().includes("type") || key.includes("유형") || key.includes("카테고리")) rawType = val;
        if (key.toLowerCase().includes("district") || key.includes("구")) district = val;
      });

      const coordText = pm.getElementsByTagName("coordinates")[0]?.textContent?.trim();
      if (!coordText) return;
      const [lng, lat] = coordText.split(",").map(Number);
      if (!lat || !lng) return;

      const typeLabel = normalizeType(rawType, name, descRaw);

      // 4개 유형 아닌 건 기본적으로 숨김(그래도 데이터는 유지)
      // -> 필요하면 "기타" 보기 기능 추가 가능
      const marker = new google.maps.Marker({
        position: {lat, lng},
        map,
        title: name,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 7,
          fillColor: typeColor(typeLabel),
          fillOpacity: 1,
          strokeWeight: 1,
          strokeColor: "#ffffff",
        }
      });

      marker.addListener("click", ()=>{
        infoWindow.close();
        const html = `
          <div style="font-size:14px;line-height:1.45;">
            <div style="font-weight:700;margin-bottom:4px;">${name}</div>
            <div style="color:#444;margin-bottom:6px;">${descRaw || ""}</div>
            <div style="font-size:12px;color:#777;margin-bottom:8px;">
              유형: ${typeLabel} ${district ? " · " + district : ""}
            </div>
            <a target="_blank"
               href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}"
               style="display:inline-block;padding:6px 8px;border-radius:8px;background:#111;color:#fff;text-decoration:none;font-size:12px;">
              길찾기
            </a>
          </div>
        `;
        infoWindow.setContent(html);
        infoWindow.open(map, marker);
      });

      allMarkers.push({ marker, district, typeLabel, name, desc: descRaw });
    });
  }

  function fitToMarkers(){
    if (!allMarkers.length) return;
    const bounds = new google.maps.LatLngBounds();
    allMarkers.forEach(o=>bounds.extend(o.marker.getPosition()));
    map.fitBounds(bounds);
  }
</script>

<!-- ✅ 너의 API 키로 교체 -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRFrDGLMi8UZgAoDITyJu694vKXdTglbU&callback=initMap&language=ko">
</script>
</body>
</html>

