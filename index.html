<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>ATS 스마트맵</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { margin:0; display:flex; height:100vh; font-family:system-ui, sans-serif; }
  .panel {
    width:330px; padding:16px; border-right:1px solid #e5e7eb;
    background:#fff; overflow-y:auto;
  }
  .title { font-size:20px; font-weight:800; margin-bottom:10px; }
  .chip-row { display:flex; flex-wrap:wrap; gap:8px; }
  .chip {
    padding:6px 12px; border-radius:999px;
    background:#f3f4f6; cursor:pointer; font-size:13px;
  }
  .chip.active { background:#2563eb; color:white; }
  #map { flex:1; }
</style>
</head>

<body>
<div class="panel">
  <div class="title">ATS 보조기기 스마트맵</div>

  <h4>구 선택</h4>
  <div class="chip-row" id="districtChips">
    <div class="chip active" data-district="ALL">전체</div>
    <div class="chip" data-district="광진구">광진구</div>
    <div class="chip" data-district="성동구">성동구</div>
    <div class="chip" data-district="중구">중구</div>
    <div class="chip" data-district="관악구">관악구</div>
    <div class="chip" data-district="강동구">강동구</div>
    <div class="chip" data-district="송파구">송파구</div>
    <div class="chip" data-district="강남구">강남구</div>
    <div class="chip" data-district="서초구">서초구</div>
  </div>

  <h4 style="margin-top:14px;">유형 선택</h4>
  <div class="chip-row" id="typeChips">
    <div class="chip active" data-type="ALL">전체</div>
    <div class="chip" data-type="전동휠체어 충전소">전동휠체어 충전소</div>
    <div class="chip" data-type="수리 지정업체">수리 지정업체</div>
    <div class="chip" data-type="휠체어 대여소">휠체어 대여소</div>
    <div class="chip" data-type="휴대용 충전기 대여소">휴대용 충전기 대여소</div>
  </div>
</div>

<div id="map"></div>

<script>
let map, infoWindow;
let markers = [];
let activeDistrict = "ALL";
let activeType = "ALL";

/* ✅ 자동 색상 생성: 구 몇 개든 OK */
function colorFromText(text){
  let hash = 0;
  for (let i = 0; i < text.length; i++) {
    hash = text.charCodeAt(i) + ((hash << 5) - hash);
  }
  return `hsl(${Math.abs(hash) % 360}, 60%, 50%)`;
}

/* ✅ 기존 + 신규 KML 전부 */
const kmlUrls = [
  "kml/GwangsungATSMAPS.kml",
  "kml/KangnamseochoATSMAPS.kml",
  "kml/GangdongsongpaATSMAPS.kml",
  "kml/JungguWheelchairCharge.kml",
  "kml/GwanakWheelchairCharge.kml"
];

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center:{ lat:37.55, lng:127.0 },
    zoom:12,
    mapTypeControl:false,
    streetViewControl:false
  });
  infoWindow = new google.maps.InfoWindow();
  kmlUrls.forEach(loadKML);
}

function loadKML(url) {
  fetch(url).then(r=>r.text()).then(txt=>{
    const xml = new DOMParser().parseFromString(txt,"text/xml");
    xml.querySelectorAll("Placemark").forEach(pm=>{
      const name = pm.querySelector("name")?.textContent || "";
      const desc = pm.querySelector("description")?.textContent || "";
      const coords = pm.querySelector("coordinates")?.textContent.trim().split(",");
      const lat = parseFloat(coords[1]);
      const lng = parseFloat(coords[0]);

      let district="", type="";
      pm.querySelectorAll("Data").forEach(d=>{
        if(d.getAttribute("name")==="district") district=d.textContent;
        if(d.getAttribute("name")==="type") type=d.textContent;
      });

      const marker = new google.maps.Marker({
        position:{ lat, lng },
        map,
        icon:{
          path:google.maps.SymbolPath.CIRCLE,
          scale:6,
          fillColor: colorFromText(district),
          fillOpacity:0.95,
          strokeColor:"#fff",
          strokeWeight:1
        }
      });

      marker.meta = { district, type, name, desc };
      marker.addListener("click", ()=>{
        infoWindow.setContent(`
          <b>${name}</b><br/>
          ${district} · ${type}<br/><br/>
          ${desc}
        `);
        infoWindow.open(map, marker);
      });

      markers.push(marker);
      applyFilter();
    });
  });
}

function applyFilter(){
  markers.forEach(m=>{
    const d=m.meta;
    const okD = activeDistrict==="ALL" || d.district===activeDistrict;
    const okT = activeType==="ALL" || d.type===activeType;
    m.setVisible(okD && okT);
  });
}

document.getElementById("districtChips").onclick=e=>{
  const c=e.target.closest(".chip"); if(!c) return;
  [...c.parentNode.children].forEach(x=>x.classList.remove("active"));
  c.classList.add("active");
  activeDistrict=c.dataset.district;
  applyFilter();
};
document.getElementById("typeChips").onclick=e=>{
  const c=e.target.closest(".chip"); if(!c) return;
  [...c.parentNode.children].forEach(x=>x.classList.remove("active"));
  c.classList.add("active");
  activeType=c.dataset.type;
  applyFilter();
};
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRFrDGLMi8UZgAoDITyJu694vKXdTglbU&callback=initMap" async defer></script>
</body>
</html>
