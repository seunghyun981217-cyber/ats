<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ATS 스마트맵</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #f5f5f5;
    }
    header {
      padding: 10px 16px;
      background: #1976d2;
      color: #fff;
      font-weight: 600;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header span.subtitle {
      font-size: 13px;
      font-weight: 400;
      opacity: 0.9;
    }
    #controls {
      padding: 8px 16px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      z-index: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: #555;
    }
    .control-group label {
      font-weight: 600;
    }
    select {
      min-width: 130px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
      background: #fff;
    }
    select:disabled {
      background: #eee;
      color: #999;
    }
    #map {
      flex: 1;
      width: 100%;
    }
    @media (max-width: 600px) {
      header {
        font-size: 16px;
        flex-direction: column;
        align-items: flex-start;
      }
      #controls {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>ATS 스마트맵</div>
    <span class="subtitle">이동보조기기 수리 · 충전 · 공기주입 · 대여 정보</span>
  </header>

  <div id="controls">
    <div class="control-group">
      <label for="districtSelect">① 구 선택</label>
      <select id="districtSelect">
        <option value="ALL">전체 보기</option>
        <option value="광진구">광진구</option>
        <option value="성동구">성동구</option>
        <option value="강남구">강남구</option>
        <option value="서초구">서초구</option>
        <option value="송파구">송파구</option>
        <option value="강동구">강동구</option>
      </select>
    </div>

    <div class="control-group">
      <label for="typeSelect">② 유형 선택</label>
      <select id="typeSelect" disabled>
        <option value="ALL">모든 유형</option>
        <option value="수리">수리</option>
        <option value="충전">충전</option>
        <option value="공기">공기주입</option>
        <option value="대여">대여</option>
      </select>
    </div>
  </div>

  <div id="map"></div>

  <script>
    // --- 구 색상 설정 (동그란 점 색상) ---
    const DISTRICT_COLORS = {
      "광진구": "#F44336", // 빨강
      "성동구": "#9C27B0", // 보라
      "강남구": "#2196F3", // 파랑
      "서초구": "#4CAF50", // 초록
      "송파구": "#FFC107", // 노랑
      "강동구": "#FF5722"  // 주황
    };

    // --- KML 파일 경로 (필요에 따라 수정해서 사용) ---
    // 이 HTML과 같은 GitHub 리포지토리 안에 /kml 폴더를 만들고
    // 그 안에 KML 파일들을 넣었다고 가정한 경로입니다.
    const DISTRICT_KMLS = {
      "광진구": "kml/GwangsungATSMAPS.kml",
      "성동구": "kml/GwangsungATSMAPS.kml",
      "강남구": "kml/KangnamseochoATSMAPS.kml",
      "서초구": "kml/KangnamseochoATSMAPS.kml",
      "송파구": "kml/GangdongsongpaATSMAPS.kml",
      "강동구": "kml/GangdongsongpaATSMAPS.kml"
    };

    let map;
    let allMarkers = []; // { marker, district, type }

    // --- 동그란 점 아이콘 생성 ---
    function createCircleIcon(color) {
      return {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: color,
        fillOpacity: 1,
        strokeColor: "#ffffff",
        strokeWeight: 1.5,
        scale: 8
      };
    }

    // --- 유형 추출 (이름/설명에서 단어 보고 대충 분류) ---
    function detectType(name, desc) {
      const text = ((name || "") + " " + (desc || "")).toLowerCase();

      if (text.includes("수리") || text.includes("센터")) return "수리";
      if (text.includes("충전")) return "충전";
      if (text.includes("공기") || text.includes("바퀴") || text.includes("타이어")) return "공기";
      if (text.includes("대여") || text.includes("대여소")) return "대여";

      return "기타";
    }

    // --- 지도 스타일(최적화: POI/건물 이름 최소화) ---
    const MINIMAL_STYLE = [
      { featureType: "poi", stylers: [{ visibility: "off" }] },
      { featureType: "transit", stylers: [{ visibility: "off" }] },
      { featureType: "administrative", elementType: "labels", stylers: [{ visibility: "off" }] },
      { featureType: "road", elementType: "labels.icon", stylers: [{ visibility: "off" }] },
      { featureType: "poi.park", stylers: [{ visibility: "simplified" }] }
    ];

    // --- 지도 초기화 ---
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 37.54, lng: 127.07 },
        zoom: 12,
        styles: MINIMAL_STYLE,
        mapTypeControl: false,
        streetViewControl: false
      });

      // 모든 구 KML 한 번에 로딩
      loadAllDistricts();

      // 컨트롤 이벤트 연결
      const districtSelect = document.getElementById("districtSelect");
      const typeSelect = document.getElementById("typeSelect");

      districtSelect.addEventListener("change", () => {
        // 구가 전체면 유형 선택 비활성화
        if (districtSelect.value === "ALL") {
          typeSelect.disabled = true;
          typeSelect.value = "ALL";
        } else {
          typeSelect.disabled = false;
        }
        applyFilter();
      });

      typeSelect.addEventListener("change", applyFilter);
    }

    // --- 모든 구 KML 불러오기 ---
    async function loadAllDistricts() {
      const districtNames = Object.keys(DISTRICT_KMLS);
      for (const district of districtNames) {
        const url = DISTRICT_KMLS[district];
        await loadKmlForDistrict(district, url);
      }
    }

    // --- 특정 구의 KML 불러서 마커 생성 ---
    async function loadKmlForDistrict(district, kmlUrl) {
      try {
        const res = await fetch(kmlUrl);
        if (!res.ok) {
          console.warn("KML 로드 실패:", district, kmlUrl);
          return;
        }
        const text = await res.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "text/xml");

        const placemarks = xml.getElementsByTagName("Placemark");
        const color = DISTRICT_COLORS[district] || "#4285F4";

        for (let i = 0; i < placemarks.length; i++) {
          const pm = placemarks[i];
          const nameNode = pm.getElementsByTagName("name")[0];
          const descNode = pm.getElementsByTagName("description")[0];
          const coordNode = pm.getElementsByTagName("coordinates")[0];

          const name = nameNode ? nameNode.textContent : "";
          const desc = descNode ? descNode.textContent : "";
          const coords = coordNode ? coordNode.textContent.trim() : "";

          if (!coords) continue;

          const parts = coords.split(",");
          const lng = parseFloat(parts[0]);
          const lat = parseFloat(parts[1]);
          if (isNaN(lat) || isNaN(lng)) continue;

          const type = detectType(name, desc);

          const marker = new google.maps.Marker({
            position: { lat, lng },
            map,
            title: name,
            icon: createCircleIcon(color)
          });

          const infoHtml = `
            <div style="min-width:200px;font-size:13px;">
              <div style="font-weight:600;margin-bottom:4px;">${name || "이름 없음"}</div>
              <div style="white-space:pre-wrap;">${desc || ""}</div>
              <div style="margin-top:4px;font-size:11px;color:#666;">구: ${district} / 유형: ${type}</div>
            </div>
          `;

          const infoWindow = new google.maps.InfoWindow({ content: infoHtml });
          marker.addListener("click", () => {
            infoWindow.open(map, marker);
          });

          allMarkers.push({ marker, district, type });
        }
      } catch (e) {
        console.error("KML 파싱 에러:", district, e);
      }
    }

    // --- 필터 적용 ---
    function applyFilter() {
      const districtVal = document.getElementById("districtSelect").value;
      const typeVal = document.getElementById("typeSelect").value;

      allMarkers.forEach(({ marker, district, type }) => {
        let visible = true;

        if (districtVal !== "ALL" && district !== districtVal) {
          visible = false;
        }
        if (typeVal !== "ALL" && type !== typeVal) {
          visible = false;
        }

        marker.setMap(visible ? map : null);
      });
    }
  </script>

  <!-- TODO: 여기에 본인 Google Maps API 키로 교체하기 -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" async defer></script>
</body>
</html>
