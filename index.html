<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ATS ìŠ¤ë§ˆíŠ¸ë§µ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --blue:#1976d2;
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --radius:14px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }
    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      height:100vh;
      width:100vw;
    }
    aside{
      background:var(--card);
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
      padding:14px;
      gap:12px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:6px 6px 10px;
      border-bottom:1px solid var(--border);
    }
    .brand h1{
      margin:0;
      font-size:20px;
      font-weight:800;
      letter-spacing:-0.3px;
      color:var(--blue);
    }
    .brand p{
      margin:0;
      font-size:12.5px;
      color:var(--muted);
      line-height:1.35;
    }
    .section{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .section label{
      font-size:12px;
      font-weight:700;
      color:#374151;
      display:flex;
      align-items:center;
      gap:6px;
    }
    select, input[type="search"]{
      width:100%;
      padding:9px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:14px;
      background:#fff;
      outline:none;
    }
    select:disabled{
      background:#f3f4f6;
      color:#9ca3af;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .chip{
      padding:6px 9px;
      border:1px solid var(--border);
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      background:#fff;
      color:#374151;
      user-select:none;
      transition:all .15s ease;
    }
    .chip.active{
      background:var(--blue);
      color:#fff;
      border-color:var(--blue);
    }
    .legend{
      margin-top:auto;
      padding-top:10px;
      border-top:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color:var(--muted);
    }
    .legend-row{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      border:1.5px solid #fff; box-shadow:0 0 0 1px rgba(0,0,0,.08);
    }
    .btn{
      width:100%;
      padding:9px 10px;
      border:none;
      border-radius:10px;
      background:#111827;
      color:#fff;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
    }
    .helper{
      font-size:12px;color:var(--muted);line-height:1.35;
    }

    main{
      position:relative;
      padding:10px;
    }
    #map{
      height:100%;
      width:100%;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
      overflow:hidden;
      background:#e5e7eb;
    }
    .loading{
      position:absolute; inset:10px;
      background:rgba(255,255,255,.85);
      border-radius:16px;
      display:flex; align-items:center; justify-content:center;
      font-weight:700; color:#374151;
      backdrop-filter: blur(2px);
      z-index:5;
    }
    .loading.hidden{ display:none; }
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <div class="brand">
        <h1>ATS ìŠ¤ë§ˆíŠ¸ë§µ</h1>
        <p>
          ì„œìš¸ ì´ë™ë³´ì¡°ê¸°ê¸° ì‚¬ìš©ìë“¤ì„ ìœ„í•œ<br/>
          ìˆ˜ë¦¬ Â· ì¶©ì „ Â· ê³µê¸°ì£¼ì… Â· ëŒ€ì—¬ Â· ì„¼í„° ì •ë³´ë¥¼ í•œëˆˆì—.
        </p>
      </div>

      <div class="section full">
        <label for="searchInput">ğŸ” ê²€ìƒ‰</label>
        <input id="searchInput" type="search" placeholder="ì¥ì†Œëª…/ì„¤ëª…ì—ì„œ ê²€ìƒ‰" />
        <div class="helper">ê²€ìƒ‰ì–´ê°€ í¬í•¨ëœ ë§ˆì»¤ë§Œ ë‚¨ê²¨ì„œ ë³´ì—¬ì¤˜ìš”.</div>
      </div>

      <div class="section">
        <label for="districtSelect">ğŸ“ êµ¬ ì„ íƒ</label>
        <select id="districtSelect">
          <option value="ALL">ì „ì²´ ë³´ê¸°</option>
          <option value="ê´‘ì§„êµ¬">ê´‘ì§„êµ¬</option>
          <option value="ì„±ë™êµ¬">ì„±ë™êµ¬</option>
          <option value="ê°•ë‚¨êµ¬">ê°•ë‚¨êµ¬</option>
          <option value="ì„œì´ˆêµ¬">ì„œì´ˆêµ¬</option>
          <option value="ì†¡íŒŒêµ¬">ì†¡íŒŒêµ¬</option>
          <option value="ê°•ë™êµ¬">ê°•ë™êµ¬</option>
        </select>
      </div>

      <div class="section">
        <label for="typeSelect">ğŸ§© ìœ í˜• ì„ íƒ</label>
        <select id="typeSelect" disabled>
          <option value="ALL">ëª¨ë“  ìœ í˜•</option>
          <option value="ìˆ˜ë¦¬">ìˆ˜ë¦¬</option>
          <option value="ì¶©ì „">ì¶©ì „</option>
          <option value="ê³µê¸°">ê³µê¸°ì£¼ì…</option>
          <option value="ëŒ€ì—¬">ëŒ€ì—¬</option>
          <option value="ì„¼í„°">ì„¼í„°</option>
          <option value="íŒë§¤">íŒë§¤</option>
        </select>
      </div>

      <button class="btn" id="resetBtn">í•„í„° ì´ˆê¸°í™”</button>

      <div class="legend" id="legend"></div>
    </aside>

    <main>
      <div id="map"></div>
      <div class="loading" id="loading">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    </main>
  </div>
<script>
const DISTRICT_COLORS = {
  "ê´‘ì§„êµ¬": "#F44336",
  "ì„±ë™êµ¬": "#9C27B0",
  "ê°•ë‚¨êµ¬": "#2196F3",
  "ì„œì´ˆêµ¬": "#4CAF50",
  "ì†¡íŒŒêµ¬": "#FFC107",
  "ê°•ë™êµ¬": "#FF5722"
};

const DISTRICT_KMLS = {
  "ê´‘ì§„êµ¬": "kml/GwangsungATSMAPS.kml",
  "ì„±ë™êµ¬": "kml/GwangsungATSMAPS.kml",
  "ê°•ë‚¨êµ¬": "kml/KangnamseochoATSMAPS.kml",
  "ì„œì´ˆêµ¬": "kml/KangnamseochoATSMAPS.kml",
  "ì†¡íŒŒêµ¬": "kml/GangdongsongpaATSMAPS.kml",
  "ê°•ë™êµ¬": "kml/GangdongsongpaATSMAPS.kml"
};

const MINIMAL_STYLE = [
  { featureType:"poi", stylers:[{visibility:"off"}] },
  { featureType:"transit", stylers:[{visibility:"off"}] },
  { featureType:"administrative", elementType:"labels", stylers:[{visibility:"off"}] },
  { featureType:"road", elementType:"labels.icon", stylers:[{visibility:"off"}] }
];

let map;
let allMarkers = [];
let activeInfoWindow = null;

// ì•„ì´ì½˜ ìƒì„±
function createCircleIcon(color){
  return {
    path: google.maps.SymbolPath.CIRCLE,
    fillColor: color,
    fillOpacity: 1,
    strokeColor: "#ffffff",
    strokeWeight: 1.5,
    scale: 8
  };
}

// ìœ í˜• íŒë³„
function detectType(name, desc){
  const txt = (name + " " + desc).toLowerCase();
  if(txt.includes("ì„¼í„°")) return "ì„¼í„°";
  if(txt.includes("íŒë§¤")) return "íŒë§¤";
  if(txt.includes("ìˆ˜ë¦¬")) return "ìˆ˜ë¦¬";
  if(txt.includes("ì¶©ì „")) return "ì¶©ì „";
  if(txt.includes("ê³µê¸°") || txt.includes("íƒ€ì´ì–´")) return "ê³µê¸°";
  if(txt.includes("ëŒ€ì—¬")) return "ëŒ€ì—¬";
  return "ê¸°íƒ€";
}

// ì§€ë„ ì´ˆê¸°í™”
function initMap(){
  map = new google.maps.Map(document.getElementById("map"), {
    center:{lat:37.54, lng:127.07},
    zoom:12,
    styles: MINIMAL_STYLE,
    streetViewControl:false,
    mapTypeControl:false
  });

  buildLegend();
  wireUI();
  loadAll().then(()=>{
    document.getElementById("loading").classList.add("hidden");
    applyFilter();
  });
}

// ë²”ë¡€
function buildLegend(){
  const legend = document.getElementById("legend");
  legend.innerHTML = "<b style='color:#374151;'>êµ¬ë³„ ìƒ‰ìƒ</b>";
  Object.entries(DISTRICT_COLORS).forEach(([d,c])=>{
    legend.innerHTML += `
      <div class="legend-row">
        <span class="dot" style="background:${c}"></span>
        <span>${d}</span>
      </div>`;
  });
}

async function loadAll(){
  for(const d of Object.keys(DISTRICT_KMLS)){
    await loadKml(d, DISTRICT_KMLS[d]);
  }
}

async function loadKml(district, url){
  try{
    const res = await fetch(url);
    const text = await res.text();
    const xml = new DOMParser().parseFromString(text,"text/xml");
    const placemarks = xml.getElementsByTagName("Placemark");

    for(const pm of placemarks){
      const name = pm.getElementsByTagName("name")[0]?.textContent || "";
      const desc = pm.getElementsByTagName("description")[0]?.textContent || "";
      const coords = pm.getElementsByTagName("coordinates")[0]?.textContent.trim();

      if(!coords) continue;

      const [lng, lat] = coords.split(",").map(Number);
      if(isNaN(lat)||isNaN(lng)) continue;

      const type = detectType(name, desc);
      const color = DISTRICT_COLORS[district];

      const marker = new google.maps.Marker({
        position:{lat,lng},
        title:name,
        map,
        icon:createCircleIcon(color)
      });

      const infoHtml = `
        <div style="min-width:220px;font-size:13px;">
          <div style="font-weight:700;margin-bottom:4px;">${name}</div>
          <div style="white-space:pre-wrap;">${desc}</div>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}"
             target="_blank"
             style="display:inline-block;margin-top:8px;color:#1976d2;font-weight:600;">
             ğŸ“ ê¸¸ì°¾ê¸°
          </a>
        </div>
      `;

      const infoWindow = new google.maps.InfoWindow({content:infoHtml});

      marker.addListener("click", ()=>{
        if(activeInfoWindow){
          activeInfoWindow.close();
        }
        infoWindow.open(map, marker);
        activeInfoWindow = infoWindow;

        marker.setMap(map); // í´ë¦­í•´ë„ ì‚¬ë¼ì§€ì§€ ì•Šê²Œ
      });

      allMarkers.push({marker, district, type, name, desc});
    }

  }catch(e){
    console.error("KML ë¡œë“œ ì˜¤ë¥˜:", e);
  }
}

// UI í•„í„°
function wireUI(){
  const dSel = document.getElementById("districtSelect");
  const tSel = document.getElementById("typeSelect");
  const sInp = document.getElementById("searchInput");

  dSel.addEventListener("change", ()=>{
    if(dSel.value==="ALL"){
      tSel.disabled = true;
      tSel.value="ALL";
    }else{
      tSel.disabled = false;
    }
    applyFilter();
  });

  tSel.addEventListener("change", applyFilter);
  sInp.addEventListener("input", applyFilter);

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    dSel.value="ALL";
    tSel.value="ALL";
    tSel.disabled=true;
    sInp.value="";
    applyFilter();
  });
}

// í•„í„° ì ìš©
function applyFilter(){
  const dVal = districtSelect.value;
  const tVal = typeSelect.value;
  const q = searchInput.value.toLowerCase();

  allMarkers.forEach(o=>{
    let v = true;

    if(dVal !== "ALL" && o.district !== dVal) v=false;
    if(tVal !== "ALL" && o.type !== tVal) v=false;

    if(q && !(o.name+o.desc).toLowerCase().includes(q)) v=false;

    o.marker.setMap(v ? map : null);
  });
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRFrDGLMi8UZgAoDITyJu694vKXdTglbU&callback=initMap" async defer></script>
</body>
</html>
